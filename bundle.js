(()=>{"use strict";(()=>{const e=function(e,t){const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения! Проверьте подключение к интернету и повторите попытку позже")})),o.addEventListener("timeout",(()=>{t(`Запрос на получение данных не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o};window.server={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},upload:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},onError:e=>{const t=document.createElement("div");t.style="z-index: 100",t.style.margin="auto",t.style.textAlign="center",t.style.backgroundColor="#ff5635",t.style.color="white",t.style.height="115px",t.style.width="800px",t.style.paddingTop="15px",t.style.paddingBottom="40px",t.style.position="absolute",t.style.top="150px",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,t.style.cursor="pointer",document.body.insertAdjacentElement("afterbegin",t),t.addEventListener("click",(()=>{t.remove()}))}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=t.minLength,n=e.querySelector("#price"),r=()=>{n.validity.rangeUnderflow?n.setCustomValidity("Цена не может быть меньше "+n.min):n.validity.rangeOverflow?n.setCustomValidity("Цена не может быть больше "+n.max):n.setCustomValidity("")},i={bungalow:0,flat:1e3,house:5e3,palace:1e4},s=e=>{n.setAttribute("min",e),n.setAttribute("placeholder",e)},a=e.querySelector("#type");let d=i[a.value];s(d);const c=()=>{d=i[a.value],s(d)};c();const l=e.querySelector("#timein"),u=e.querySelector("#timeout"),p=e.querySelector("#room_number"),m=e.querySelector("#capacity"),v={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},y=()=>{let e=p.value,t=m.querySelectorAll("option");t.forEach((t=>{t.disabled=-1===v[e].indexOf(t.value)})),t[m.selectedIndex].disabled&&(m.querySelector("option:not([disabled])").selected=!0)};y(),window.form={template:e,addTitle:t,addPrice:n,checkOut:u,checkIn:l,accomodationType:a,setAllowedCapacity:y,addRoomsAmount:p,onAddTitleSetCustomValidity:()=>{const e=t.value.length;e<o?t.setCustomValidity("Минимальная длина — 30 символов, ещё "+(o-e)):t.setCustomValidity(""),t.reportValidity()},onInvalidAddPriceCheckValidity:()=>{r()},onInputAddPriceCheckValidity:()=>{r()},onChangeAccomodationType:c,onChangeCheckIn:()=>{var e;e=l.value,u.value=e},onChangeCheckOut:()=>{var e;e=u.value,l.value=e},onChangeAddRoomsAmount:()=>{y()}}})(),(()=>{const{template:e}=window.form,t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),n=e.querySelector("#address"),r=Math.floor(o.offsetLeft+32.5),i=Math.floor(o.offsetTop+32),s=()=>{n.value=`${r}, ${i}`};s(),n.setAttribute("readonly","true"),window.starterPin={assignAddress:()=>{const e=Math.floor(o.offsetTop+64),t=Math.floor(o.offsetLeft+32.5);n.value=`${t}, ${e}`},pinsArea:t,mainPin:o,PIN_WIDTH:65,PIN_HEIGHT:64,PIN_INCEPTION_X:570,PIN_INCEPTION_Y:375,setMainPinPosition:s}})(),(()=>{const{isEscEvent:e}=window.util,t=document.querySelector(".map"),o=document.querySelector(".map__filters-container"),n=t=>{e(t,r)},r=()=>{const e=t.querySelector(".map__card");e&&e.remove(),document.removeEventListener("keydown",n)};window.card={chart:t,showBlurb:e=>{r(),(e=>{const n=document.querySelector("#card").content.cloneNode(!0),i=document.createDocumentFragment(),{title:s,address:a,price:d,type:c,rooms:l,guests:u,checkin:p,checkout:m,features:v,description:y,photos:f}=e.offer,{avatar:h}=e.author;n.querySelector(".popup__close").addEventListener("click",(()=>{r()}));const w=n.querySelector(".popup__features");w.innerHTML="",n.querySelector(".popup__type").textContent={flat:"квартира",bungalow:"бунгало",house:"дом",palace:"дворец"}[c],n.querySelector(".popup__title").textContent=s,n.querySelector(".popup__text--address").textContent=a,n.querySelector(".popup__text--price").textContent=d+"₽/ночь",n.querySelector(".popup__text--capacity").textContent=`${l} комнат${(e=>{let t=e;return e>20&&(t=e%10),e>=5&&e<=20?"":{0:"",1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:""}[t]})(l)} для ${u} гост${(e=>{let t=e;return e>=10&&(t=e%10),1===t?"я":"ей"})(u)}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${p}, выезд до ${m}`,w.appendChild(function(e,t){return e.forEach((e=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+e,t.appendChild(o)})),t}(v,i)),n.querySelector(".popup__description").textContent=y,((e,t)=>{const o=e.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");o.innerHTML="",t.forEach((e=>{const t=n.cloneNode(!0);t.src=e,i.appendChild(t)})),o.appendChild(i)})(n,f),n.querySelector(".popup__avatar").src=h,t.insertBefore(n,o)})(e),document.addEventListener("keydown",n)},shutBlurb:r,container:o}})(),(()=>{const{showBlurb:e}=window.card;window.pin={create:t=>{const o=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.createDocumentFragment();return t.forEach((t=>{const r=o.cloneNode(!0),i=r.querySelector("img");r.style=`left: ${t.location.x-i.width/2}px;\n                   top: ${t.location.y-i.height}px;`,i.src=t.author.avatar,i.alt=t.offer.title,n.append(r),r.addEventListener("click",(()=>{e(t)}))})),n}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="any",{create:t}=window.pin,{shutBlurb:o,chart:n}=window.card,{pinsArea:r}=window.starterPin,i=n.querySelector(".map__filters"),s=i.querySelectorAll("select"),a=i.querySelectorAll("input"),d=i.querySelector("#housing-type"),c=i.querySelector("#housing-price"),l=i.querySelector("#housing-rooms"),u=i.querySelector("#housing-guests"),p=i.querySelector(".map__features"),m=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};let v;const y=window.debounce((e=>{m(),r.append(t(e.slice(0,5)))}));window.map={chart:n,selects:s,inputs:a,erasePins:m,onLoad:e=>{v=e,y(e)},filter:i,onFilterGetBlurbs:()=>{const t=[];v.forEach((o=>{(t=>d.value===t.offer.type||d.value===e)(o)&&(t=>"low"===c.value&&t.offer.price<1e4||"middle"===c.value&&t.offer.price>=1e4&&t.offer.price<5e4||"high"===c.value&&t.offer.price>=5e4||c.value===t.offer.price||c.value===e)(o)&&(t=>+l.value===t.offer.rooms||l.value===e)(o)&&(t=>+u.value===t.offer.guests||u.value===e)(o)&&(e=>{const t=p.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(o)&&t.push(o)})),o(),y(t)}}})(),(()=>{const{PIN_WIDTH:e,PIN_HEIGHT:t,assignAddress:o,pinsArea:n,mainPin:r}=window.starterPin,{chart:i}=window.map,s=n.offsetWidth,a=i.offsetTop+130-t,d=630-t,c=0+Math.ceil(e/2)-r.offsetWidth,l=s+Math.ceil(e/2)-r.offsetWidth;window.dragging={onStarterPinMouseMove:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const s=r.offsetLeft-n,u=r.offsetTop-i;s>=c&&s<=l&&(r.style.left=s+"px"),u>=a&&u<=d&&(r.style.top=u+"px"),o()},i=t=>{1===e.button&&t.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",i)}}})(),(()=>{const{selects:e,inputs:t,erasePins:o,onLoad:n,filter:r,onFilterGetBlurbs:i}=window.map,{assignAddress:s,mainPin:a,PIN_INCEPTION_X:d,PIN_INCEPTION_Y:c,setMainPinPosition:l}=window.starterPin,{shutBlurb:u,chart:p,container:m}=window.card,{isEnterEvent:v,isEscEvent:y,onError:f}=window.util,{onStarterPinMouseMove:h}=window.dragging,{load:w,upload:E}=window.server,{clearPhotos:_}=window.images,{template:L,setAllowedCapacity:g,addTitle:S,addPrice:q,checkIn:b,checkOut:C,accomodationType:A,addRoomsAmount:k,onAddTitleSetCustomValidity:x,onInvalidAddPriceCheckValidity:P,onInputAddPriceCheckValidity:I,onChangeAccomodationType:T,onChangeCheckIn:N,onChangeCheckOut:M,onChangeAddRoomsAmount:$}=window.form,D=L.querySelectorAll("select"),V=L.querySelectorAll("input"),O=L.querySelector("#description"),B=L.querySelector(".ad-form__element--submit"),H=e=>{e.forEach((e=>{e.setAttribute("disabled","true")}))},X=e=>{e.forEach((e=>{e.removeAttribute("disabled","true")}))};m.classList.add("hidden"),H(D),H(V),H(e),H(t),O.setAttribute("disabled","true"),B.setAttribute("disabled","true");const F=e=>{0===e.button&&oe()},G=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),R=()=>{j()},W=e=>{y(e,j)},Y=e=>{v(e,oe)},j=()=>{G.remove(),document.removeEventListener("click",R),document.removeEventListener("keydown",W)},z=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),U=()=>{p.appendChild(z),document.addEventListener("click",J),document.addEventListener("keydown",K)},J=()=>{Q()},K=e=>{y(e,Q)},Q=()=>{z.remove(),document.removeEventListener("click",J),document.removeEventListener("keydown",K)},Z=document.querySelector(".ad-form__reset"),ee=e=>{e.preventDefault(),te()},te=()=>{u(),o(),L.reset(),g(),p.classList.add("map--faded"),L.classList.add("ad-form--disabled"),s(),T(),a.style.left=d+"px",a.style.top=c+"px",l(),H(e),H(t),H(D),H(V),m.classList.add("hidden"),O.setAttribute("disabled","true"),B.setAttribute("disabled","true"),a.addEventListener("mousedown",F),Z.removeEventListener("click",ee),r.removeEventListener("change",i),S.removeEventListener("input",x),q.removeEventListener("input",I),q.removeEventListener("invalid",P),A.removeEventListener("change",T),b.removeEventListener("change",N),C.removeEventListener("change",M),k.removeEventListener("change",$),_()};a.addEventListener("mousedown",F),a.addEventListener("keydown",Y),a.addEventListener("mousedown",h);const oe=()=>{L.classList.remove("ad-form--disabled"),p.classList.remove("map--faded"),m.classList.remove("hidden"),X(D),X(V),X(e),X(t),O.removeAttribute("disabled"),B.removeAttribute("disabled"),s(),w(n,f),L.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(L);E(t,(()=>{te(),p.appendChild(G),document.addEventListener("click",R),document.addEventListener("keydown",W)}),U),document.activeElement.blur()})),a.removeEventListener("keydown",Y),a.removeEventListener("mousedown",F),Z.addEventListener("click",ee),r.addEventListener("change",i),S.addEventListener("input",x),q.addEventListener("input",I),q.addEventListener("invalid",P),A.addEventListener("change",T),b.addEventListener("change",N),C.addEventListener("change",M),k.addEventListener("change",$)}})()})();