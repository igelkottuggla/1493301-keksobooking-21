(()=>{"use strict";(()=>{const e=function(e,t){const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения! Проверьте подключение к интернету и повторите попытку позже")})),o.addEventListener("timeout",(()=>{t(`Запрос на получение данных не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o};window.server={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},upload:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),(()=>{const e=function(e,t){return Math.floor(e+Math.random()*(t+1-e))};window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},getRandomNumber:e,getRandomItem:function(t){return t[e(0,t.length-1)]},getRandomArray:function(t){return t.slice(e(0,t.length))},getRandomLocation:function(){return`${e(1,1e3)}, ${e(1,1e3)}`},onError:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: auto; text-align: center",t.style.backgroundColor="#ff5635",t.style.color="white",t.style.height="115px",t.style.width="800px",t.style.paddingTop="15px",t.style.paddingBottom="40px",t.style.position="absolute",t.style.top="150px",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,t.style.cursor="pointer",document.body.insertAdjacentElement("afterbegin",t),t.addEventListener("click",(()=>{t.remove()}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=t.minLength,n=e.querySelector("#price"),r=()=>{n.validity.rangeUnderflow?n.setCustomValidity("Цена не может быть меньше "+n.min):n.validity.rangeOverflow?n.setCustomValidity("Цена не может быть больше "+n.max):n.setCustomValidity("")},i={bungalow:0,flat:1e3,house:5e3,palace:1e4},d=function(e){n.setAttribute("min",e),n.setAttribute("placeholder",e)},a=e.querySelector("#type");let s=i[a.value];d(s);const c=e.querySelector("#timein"),l=e.querySelector("#timeout"),u=e.querySelector("#room_number"),m=e.querySelector("#capacity"),p={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},v=()=>{let e=u.value,t=m.querySelectorAll("option");t.forEach((t=>{-1===p[e].indexOf(t.value)?t.disabled=!0:t.disabled=!1})),t[m.selectedIndex].disabled&&(m.querySelector("option:not([disabled])").selected=!0)};v(),window.form={addForm:e,addTitle:t,addPrice:n,checkOut:l,checkIn:c,accomodationType:a,setAllowedCapacity:v,addRoomsAmount:u,onAddTitleSetCustomValidity:()=>{let e=t.value.length;e<o?t.setCustomValidity("Минимальная длина — 30 символов, ещё "+(o-e)):t.setCustomValidity(""),t.reportValidity()},onInvalidAddPriceCheckValidity:()=>{r()},onInputAddPriceCheckValidity:()=>{r()},onChangeAccomodationType:()=>{s=i[a.value],d(s)},onChangeCheckIn:()=>{var e;e=c.value,l.value=e},onChangeCheckOut:()=>{var e;e=l.value,c.value=e},onChangeAddRoomsAmount:()=>{v()}}})(),(()=>{const{addForm:e}=window.form,t=document.querySelector(".map__pins"),o=document.querySelector(".map__pins").clientWidth,n=t.querySelector(".map__pin--main"),r=e.querySelector("#address"),i=Math.floor(n.offsetLeft+30),d=Math.floor(n.offsetTop+32),a=function(){r.value=`${i}, ${d}`};a(),r.setAttribute("readonly","true"),window.starterPin={assignAddress:function(){const e=Math.floor(n.offsetTop+64),t=Math.floor(n.offsetLeft+30);r.value=`${t}, ${e}`},pinsArea:t,mainPin:n,locationXMax:o,PIN_WIDTH:60,PIN_HEIGHT:64,PIN_INCEPTION_X:570,PIN_INCEPTION_Y:375,setMainPinPosition:a}})(),(()=>{const{isEscEvent:e}=window.util,t=document.querySelector(".map"),o=document.querySelector(".map__filters-container"),n=t=>{e(t,r)},r=()=>{const e=t.querySelector(".map__card");e&&e.remove(),document.removeEventListener("keydown",n)};window.card={map:t,showBlurb:e=>{r(),function(e){const n=document.querySelector("#card").content.cloneNode(!0),i=document.createDocumentFragment(),{title:d,address:a,price:s,type:c,rooms:l,guests:u,checkin:m,checkout:p,features:v,description:f,photos:y}=e.offer,{avatar:h}=e.author;n.querySelector(".popup__close").addEventListener("click",(()=>{r()}));const w=n.querySelector(".popup__features");w.innerHTML="",n.querySelector(".popup__type").textContent={flat:"квартира",bungalow:"бунгало",house:"дом",palace:"дворец"}[c],n.querySelector(".popup__title").textContent=d,n.querySelector(".popup__text--address").textContent=a,n.querySelector(".popup__text--price").textContent=s+"₽/ночь",n.querySelector(".popup__text--capacity").textContent=`${l} комнат${function(e){let t=e;return e>20&&(t=e%10),e>=5&&e<=20?"":{0:"",1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:""}[t]}(l)} для ${u} гост${function(e){let t=e;return e>=10&&(t=e%10),1===t?"я":"ей"}(u)}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${m}, выезд до ${p}`,w.appendChild(function(e,t){return e.forEach((e=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+e,t.appendChild(o)})),t}(v,i)),n.querySelector(".popup__description").textContent=f,((e,t)=>{const o=e.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");o.innerHTML="",t.forEach((e=>{const t=n.cloneNode(!0);t.src=e,i.appendChild(t)})),o.appendChild(i)})(n,y),n.querySelector(".popup__avatar").src=h,t.insertBefore(n,o)}(e),document.addEventListener("keydown",n)},closeBlurb:r,container:o}})(),(()=>{const{openBlurb:e}=window.card;window.pin={create:t=>{const o=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.createDocumentFragment();return t.forEach((t=>{const r=o.cloneNode(!0),i=r.querySelector("img");r.style=`left: ${t.location.x-i.width/2}px;\n                   top: ${t.location.y-i.height}px;`,i.src=t.author.avatar,i.alt=t.offer.title,n.append(r),r.addEventListener("click",(()=>{e(t)}))})),n}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const{addForm:e}=window.form,t=["gif","jpg","jpeg","png"],o=e.querySelector("#avatar"),n=e.querySelector("#images"),r=e.querySelector(".ad-form-header__preview img"),i=e.querySelector(".ad-form__photo-container"),d=i.querySelector(".ad-form__photo"),a={default:{width:"40px",height:"44px",borderRadius:"0",marginLeft:"0"},edited:{width:"70px",height:"70px",borderRadius:"5px",marginLeft:"-15px"}},s=(e,o)=>{const n=e.name.toLowerCase();t.some((e=>n.endsWith(e)))&&o(e)},c=(e,t)=>{e.setAttribute("width",t.width),e.setAttribute("height",t.height),e.style.width=t.width,e.style.height=t.height,e.style.borderRadius=t.borderRadius,e.style.objectFit="cover"},l=e=>{const t=a.edited,o=()=>{URL.revokeObjectURL(r.src),r.removeEventListener("load",o)};r.addEventListener("load",o),r.src=URL.createObjectURL(e),c(r,t),r.style.marginLeft=t.marginLeft},u=e=>{const t=document.createElement("div");t.classList.add("ad-form__photo"),i.appendChild(t);const o=document.createElement("img"),n=a.edited,r=()=>{URL.revokeObjectURL(o.src),o.removeEventListener("load",r)};o.addEventListener("load",r),o.src=URL.createObjectURL(e),c(o,n),o.setAttribute("alt","Фотография Вашего жилья"),d.remove(),t.appendChild(o)},m=()=>{s(o.files[0],l)},p=()=>{s(n.files[0],u)};window.images={makePhotosDisabled:()=>{const t=a.default;r.style.width=t.width,r.style.height=t.height,r.style.borderRadius=t.borderRadius,r.style.marginLeft=t.marginLeft,r.src="img/muffin-grey.svg",e.querySelectorAll(".ad-form__photo").forEach((e=>{e.remove()})),i.appendChild(d),o.removeEventListener("change",m),n.removeEventListener("change",p)},makePhotosEnabled:()=>{o.addEventListener("change",m),n.addEventListener("change",p)}}})(),(()=>{const e="any",{create:t}=window.pin,{closeBlurb:o,map:n}=window.card,{pinsArea:r}=window.starterPin,i=n.querySelector(".map__filters"),d=i.querySelectorAll("select"),a=i.querySelectorAll("input"),s=i.querySelector("#housing-type"),c=i.querySelector("#housing-price"),l=i.querySelector("#housing-rooms"),u=i.querySelector("#housing-guests"),m=i.querySelector(".map__features"),p=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};let v;const f=window.debounce((e=>{p(),r.append(t(e.slice(0,5)))}));window.map={map:n,selects:d,inputs:a,erasePins:p,onLoad:e=>{v=e,f(e)},filter:i,onFilterGetBlurbs:()=>{const t=[];v.forEach((o=>{(t=>s.value===t.offer.type||s.value===e)(o)&&(t=>"low"===c.value&&t.offer.price<1e4||"middle"===c.value&&t.offer.price>=1e4&&t.offer.price<5e4||"high"===c.value&&t.offer.price>=5e4||c.value===t.offer.price||c.value===e)(o)&&(t=>+l.value===t.offer.rooms||l.value===e)(o)&&(t=>+u.value===t.offer.guests||u.value===e)(o)&&(e=>{const t=m.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(o)&&t.push(o)})),o(),f(t)}}})(),(()=>{const{PIN_WIDTH:e,PIN_HEIGHT:t,assignAddress:o,locationXMax:n,mainPin:r}=window.starterPin,{map:i}=window.map,d=n,a=i.offsetTop+130-t,s=630-t,c=0+Math.ceil(e/2)-r.offsetWidth,l=d+Math.ceil(e/2)-r.offsetWidth;window.dragging={onStarterPinMouseMove:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const d=r.offsetLeft-n,u=r.offsetTop-i;d>=c&&d<=l&&(r.style.left=d+"px"),u>=a&&u<=s&&(r.style.top=u+"px"),o()},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",i)}}})(),(()=>{const{selects:e,inputs:t,erasePins:o,onLoad:n,filter:r,onFilterGetBlurbs:i}=window.map,{addForm:d,setAllowedCapacity:a}=window.form,{assignAddress:s,mainPin:c,PIN_INCEPTION_X:l,PIN_INCEPTION_Y:u,setMainPinPosition:m}=window.starterPin,{closeBlurb:p,map:v,container:f}=window.card,{isEnterEvent:y,isEscEvent:h,onError:w}=window.util,{onStarterPinMouseMove:g}=window.dragging,{load:E,upload:L}=window.server,{makePhotosEnabled:_,makePhotosDisabled:b}=window.images,{addTitle:S,addPrice:q,checkIn:k,checkOut:C,accomodationType:A,addRoomsAmount:x,onAddTitleSetCustomValidity:P,onInvalidAddPriceCheckValidity:I,onInputAddPriceCheckValidity:T,onChangeAccomodationType:N,onChangeCheckIn:R,onChangeCheckOut:M,onChangeAddRoomsAmount:$}=window.form,O=d.querySelectorAll("select"),D=d.querySelectorAll("input"),V=d.querySelector("#description"),j=d.querySelector(".ad-form__element--submit"),F=function(e){e.forEach((e=>{e.setAttribute("disabled","true")}))},B=function(e){e.forEach((e=>{e.removeAttribute("disabled","true")}))};f.classList.add("hidden"),F(O),F(D),F(e),F(t),V.setAttribute("disabled","true"),j.setAttribute("disabled","true");const H=function(e){0===e.button&&ne()},U=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),X=()=>{Y()},W=e=>{h(e,Y)},G=e=>{y(e,ne)},Y=()=>{U.remove(),document.removeEventListener("click",X),document.removeEventListener("keydown",W)},z=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),J=function(){v.appendChild(z),document.addEventListener("click",K),document.addEventListener("keydown",Q)},K=function(){Z()},Q=function(e){h(e,Z)},Z=function(){z.remove(),document.removeEventListener("click",K),document.removeEventListener("keydown",Q)},ee=document.querySelector(".ad-form__reset"),te=()=>{oe()},oe=function(){p(),o(),d.reset(),a(),v.classList.add("map--faded"),d.classList.add("ad-form--disabled"),s(),c.style.left=l+"px",c.style.top=u+"px",m(),F(e),F(t),F(O),F(D),f.classList.add("hidden"),V.setAttribute("disabled","true"),j.setAttribute("disabled","true"),c.addEventListener("mousedown",H),ee.removeEventListener("click",te),r.removeEventListener("change",i),S.removeEventListener("input",P),q.removeEventListener("input",T),q.removeEventListener("invalid",I),A.removeEventListener("change",N),k.removeEventListener("change",R),C.removeEventListener("change",M),x.removeEventListener("change",$),b()};c.addEventListener("mousedown",H),c.addEventListener("keydown",G),c.addEventListener("mousedown",g);const ne=()=>{d.classList.remove("ad-form--disabled"),v.classList.remove("map--faded"),f.classList.remove("hidden"),B(O),B(D),B(e),B(t),V.removeAttribute("disabled","true"),j.removeAttribute("disabled","true"),s(),E(n,w),d.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(d);L(t,(()=>{oe(),v.appendChild(U),document.addEventListener("click",X),document.addEventListener("keydown",W)}),J),document.activeElement.blur()})),c.removeEventListener("keydown",G),c.removeEventListener("mousedown",H),ee.addEventListener("click",te),r.addEventListener("change",i),S.addEventListener("input",P),q.addEventListener("input",T),q.addEventListener("invalid",I),A.addEventListener("change",N),k.addEventListener("change",R),C.addEventListener("change",M),x.addEventListener("change",$),_()}})()})();