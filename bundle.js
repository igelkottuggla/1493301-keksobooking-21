(()=>{"use strict";(()=>{const e=function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t(`Статус ответа: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения! Проверьте подключение к интернету и повторите попытку позже")})),n.addEventListener("timeout",(()=>{t(`Запрос на получение данных не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n};window.server={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},upload:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),(()=>{const e=function(e,t){return Math.floor(e+Math.random()*(t+1-e))};window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},getRandomNumber:e,getRandomItem:function(t){return t[e(0,t.length-1)]},getRandomArray:function(t){return t.slice(e(0,t.length))},getRandomLocation:function(){return`${e(1,1e3)}, ${e(1,1e3)}`},onError:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: auto; text-align: center",t.style.backgroundColor="#ff5635",t.style.color="white",t.style.height="115px",t.style.width="800px",t.style.paddingTop="15px",t.style.paddingBottom="40px",t.style.position="absolute",t.style.top="150px",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,t.style.cursor="pointer",document.body.insertAdjacentElement("afterbegin",t),t.addEventListener("click",(()=>{t.remove()}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),n=t.minLength,o=e.querySelector("#price"),r=()=>{o.validity.rangeUnderflow?o.setCustomValidity("Цена не может быть меньше "+o.min):o.validity.rangeOverflow?o.setCustomValidity("Цена не может быть больше "+o.max):o.setCustomValidity("")},i={bungalow:0,flat:1e3,house:5e3,palace:1e4},a=function(e){o.setAttribute("min",e),o.setAttribute("placeholder",e)},d=e.querySelector("#type");let c=i[d.value];a(c);const s=e.querySelector("#timein"),l=e.querySelector("#timeout"),u=e.querySelector("#room_number"),p=e.querySelector("#capacity"),m={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},v=()=>{let e=u.value,t=p.querySelectorAll("option");t.forEach((t=>{-1===m[e].indexOf(t.value)?t.disabled=!0:t.disabled=!1})),t[p.selectedIndex].disabled&&(p.querySelector("option:not([disabled])").selected=!0)};v(),window.form={addForm:e,addTitle:t,addPrice:o,checkOut:l,checkIn:s,accomodationType:d,setAllowedCapacity:v,addRoomsAmount:u,onAddTitleSetCustomValidity:()=>{let e=t.value.length;e<n?t.setCustomValidity("Минимальная длина — 30 символов, ещё "+(n-e)):t.setCustomValidity(""),t.reportValidity()},onInvalidAddPriceCheckValidity:()=>{r()},onInputAddPriceCheckValidity:()=>{r()},onChangeAccomodationType:()=>{c=i[d.value],a(c)},onChangeCheckIn:()=>{var e;e=s.value,l.value=e},onChangeCheckOut:()=>{var e;e=l.value,s.value=e},onChangeAddRoomsAmount:()=>{v()}}})(),(()=>{const{addForm:e}=window.form,t=document.querySelector(".map__pins"),n=document.querySelector(".map__pins").clientWidth,o=t.querySelector(".map__pin--main"),r=e.querySelector("#address"),i=Math.floor(o.offsetLeft+30),a=Math.floor(o.offsetTop+32),d=function(){r.value=`${i}, ${a}`};d(),r.setAttribute("readonly","true"),window.starterPin={assignAddress:function(){const e=Math.floor(o.offsetTop+64),t=Math.floor(o.offsetLeft+30);r.value=`${t}, ${e}`},pinsArea:t,mainPin:o,locationXMax:n,PIN_WIDTH:60,PIN_HEIGHT:64,PIN_INCEPTION_X:570,PIN_INCEPTION_Y:375,setMainPinPosition:d}})(),(()=>{const{isEscEvent:e}=window.util,t=document.querySelector(".map"),n=document.querySelector(".map__filters-container"),o=t=>{e(t,r)},r=()=>{const e=t.querySelector(".map__card");e&&e.remove(),document.removeEventListener("keydown",o)};window.card={map:t,showBlurb:e=>{r(),function(e){const n=document.querySelector("#card").content.cloneNode(!0),o=document.createDocumentFragment(),{title:i,address:a,price:d,type:c,rooms:s,guests:l,checkin:u,checkout:p,features:m,description:v,photos:y}=e.offer,{avatar:f}=e.author;n.querySelector(".popup__close").addEventListener("click",(()=>{r()}));const h=n.querySelector(".popup__features");h.innerHTML="",n.querySelector(".popup__type").textContent={flat:"квартира",bungalow:"бунгало",house:"дом",palace:"дворец"}[c],n.querySelector(".popup__title").textContent=i,n.querySelector(".popup__text--address").textContent=a,n.querySelector(".popup__text--price").textContent=d+"₽/ночь",n.querySelector(".popup__text--capacity").textContent=`${s} комнат${function(e){let t=e;return e>20&&(t=e%10),e>=5&&e<=20?"":{0:"",1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:""}[t]}(s)} для ${l} гост${function(e){let t=e;return e>=10&&(t=e%10),1===t?"я":"ей"}(l)}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${u}, выезд до ${p}`,h.appendChild(function(e,t){return e.forEach((e=>{const n=document.createElement("li");n.className="popup__feature popup__feature--"+e,t.appendChild(n)})),t}(m,o)),n.querySelector(".popup__description").textContent=v,((e,t)=>{const n=e.querySelector(".popup__photos"),r=n.querySelector(".popup__photo");n.innerHTML="",t.forEach((e=>{const t=r.cloneNode(!0);t.src=e,o.appendChild(t)})),n.appendChild(o)})(n,y),n.querySelector(".popup__avatar").src=f,t.insertBefore(n,mapFilterContainer)}(e),document.addEventListener("keydown",o)},closeBlurb:r,container:n}})(),(()=>{const{openBlurb:e}=window.card;window.pin={create:t=>{const n=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.createDocumentFragment();return t.forEach((t=>{const r=n.cloneNode(!0),i=r.querySelector("img");r.style=`left: ${t.location.x-i.width/2}px;\n                   top: ${t.location.y-i.height}px;`,i.src=t.author.avatar,i.alt=t.offer.title,o.append(r),r.addEventListener("click",(()=>{e(t)}))})),o}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e="any",{create:t}=window.pin,{closeBlurb:n,map:o}=window.card,{pinsArea:r}=window.starterPin,i=o.querySelector(".map__filters"),a=i.querySelectorAll("select"),d=i.querySelectorAll("input"),c="low",s="middle",l="high",u=i.querySelector("#housing-type"),p=i.querySelector("#housing-price"),m=i.querySelector("#housing-rooms"),v=i.querySelector("#housing-guests"),y=i.querySelector(".map__features"),f=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};let h;const w=window.debounce((e=>{f(),r.append(t(e.slice(0,5)))}));window.map={map:o,selects:a,inputs:d,erasePins:f,onLoad:e=>{h=e,w(e)},filter:i,onFilterGetBlurbs:()=>{const t=[];h.forEach((n=>{(t=>u.value===t.offer.type||u.value===e)(n)&&(t=>p.value===c&&t.offer.price<1e4||p.value===s&&t.offer.price>=1e4&&t.offer.price<5e4||p.value===l&&t.offer.price>=5e4||p.value===t.offer.price||p.value===e)(n)&&(t=>+m.value===t.offer.rooms||m.value===e)(n)&&(t=>+v.value===t.offer.guests||v.value===e)(n)&&(e=>{const t=y.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(n)&&t.push(n)})),n(),w(t)}}})(),(()=>{const{PIN_WIDTH:e,PIN_HEIGHT:t,assignAddress:n,locationXMax:o,mainPin:r}=window.starterPin,{map:i}=window.map,a=o,d=i.offsetTop+130-t,c=630-t,s=0+Math.ceil(e/2)-r.offsetWidth,l=a+Math.ceil(e/2)-r.offsetWidth;window.dragging={onStarterPinMouseMove:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const a=r.offsetLeft-o,u=r.offsetTop-i;a>=s&&a<=l&&(r.style.left=a+"px"),u>=d&&u<=c&&(r.style.top=u+"px"),n()},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}}})(),(()=>{const{selects:e,inputs:t,erasePins:n,onLoad:o,filter:r,onFilterGetBlurbs:i}=window.map,{addForm:a,setAllowedCapacity:d}=window.form,{assignAddress:c,mainPin:s,PIN_INCEPTION_X:l,PIN_INCEPTION_Y:u,setMainPinPosition:p}=window.starterPin,{closeBlurb:m,map:v,container:y}=window.card,{isEnterEvent:f,isEscEvent:h,onError:w}=window.util,{onStarterPinMouseMove:E}=window.dragging,{load:_,upload:g}=window.server,{addTitle:L,addPrice:S,checkIn:q,checkOut:b,accomodationType:C,addRoomsAmount:k,onAddTitleSetCustomValidity:A,onInvalidAddPriceCheckValidity:x,onInputAddPriceCheckValidity:P,onChangeAccomodationType:I,onChangeCheckIn:T,onChangeCheckOut:N,onChangeAddRoomsAmount:M}=window.form,$=a.querySelectorAll("select"),V=a.querySelectorAll("input"),D=a.querySelector("#description"),O=a.querySelector(".ad-form__element--submit"),B=function(e){e.forEach((e=>{e.setAttribute("disabled","true")}))},F=function(e){e.forEach((e=>{e.removeAttribute("disabled","true")}))};y.classList.add("hidden"),B($),B(V),B(e),B(t),D.setAttribute("disabled","true"),O.setAttribute("disabled","true");const H=function(e){0===e.button&&te()},R=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),X=()=>{Y()},G=e=>{h(e,Y)},W=e=>{f(e,te)},Y=()=>{R.remove(),document.removeEventListener("click",X),document.removeEventListener("keydown",G)},j=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),z=function(){v.appendChild(j),document.addEventListener("click",U),document.addEventListener("keydown",J)},U=function(){K()},J=function(e){h(e,K)},K=function(){j.remove(),document.removeEventListener("click",U),document.removeEventListener("keydown",J)},Q=document.querySelector(".ad-form__reset"),Z=()=>{ee()},ee=function(){m(),n(),a.reset(),d(),v.classList.add("map--faded"),a.classList.add("ad-form--disabled"),c(),s.style.left=l+"px",s.style.top=u+"px",p(),B(e),B(t),B($),B(V),y.classList.add("hidden"),D.setAttribute("disabled","true"),O.setAttribute("disabled","true"),s.addEventListener("mousedown",H),Q.removeEventListener("click",Z),r.removeEventListener("change",i),L.removeEventListener("input",A),S.removeEventListener("input",P),S.removeEventListener("invalid",x),C.removeEventListener("change",I),q.removeEventListener("change",T),b.removeEventListener("change",N),k.removeEventListener("change",M)};s.addEventListener("mousedown",H),s.addEventListener("keydown",W),s.addEventListener("mousedown",E);const te=()=>{a.classList.remove("ad-form--disabled"),v.classList.remove("map--faded"),y.classList.remove("hidden"),F($),F(V),F(e),F(t),D.removeAttribute("disabled","true"),O.removeAttribute("disabled","true"),c(),_(o,w),a.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(a);g(t,(()=>{ee(),v.appendChild(R),document.addEventListener("click",X),document.addEventListener("keydown",G)}),z),document.activeElement.blur()})),s.removeEventListener("keydown",W),s.removeEventListener("mousedown",H),Q.addEventListener("click",Z),r.addEventListener("change",i),L.addEventListener("input",A),S.addEventListener("input",P),S.addEventListener("invalid",x),C.addEventListener("change",I),q.addEventListener("change",T),b.addEventListener("change",N),k.addEventListener("change",M)}})()})();