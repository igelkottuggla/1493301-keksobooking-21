(()=>{"use strict";(()=>{const e=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения! Проверьте подключение к интернету и повторите попытку позже")})),o.addEventListener("timeout",(()=>{t(`Запрос на получение данных не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o};window.server={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},upload:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},onError:e=>{const t=document.createElement("div");t.textContent=e,t.classList.add("error-message"),document.body.insertAdjacentElement("afterbegin",t),t.addEventListener("click",(()=>{t.remove()}))},roomsWordsEndings:e=>{let t=e;return e>20&&(t=e%10),e>=5&&e<=20?"":{0:"",1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:""}[t]},guestsWordsEndings:e=>{let t=e;return e>=10&&(t=e%10),1===t?"я":"ей"}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=t.minLength,n=e.querySelector("#price"),r=()=>{n.validity.rangeUnderflow?n.setCustomValidity("Цена не может быть меньше "+n.min):n.validity.rangeOverflow?n.setCustomValidity("Цена не может быть больше "+n.max):n.setCustomValidity("")},i={bungalow:0,flat:1e3,house:5e3,palace:1e4},d=e=>{n.setAttribute("min",e),n.setAttribute("placeholder",e)},s=e.querySelector("#type");let a=i[s.value];d(a);const c=()=>{a=i[s.value],d(a)};c();const l=e.querySelector("#timein"),u=e.querySelector("#timeout"),p=e.querySelector("#room_number"),m=e.querySelector("#capacity"),v={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},y=()=>{let e=p.value,t=m.querySelectorAll("option");t.forEach((t=>{t.disabled=-1===v[e].indexOf(t.value)})),t[m.selectedIndex].disabled&&(m.querySelector("option:not([disabled])").selected=!0)};y(),window.form={template:e,addTitle:t,addPrice:n,checkOut:u,checkIn:l,accomodationType:s,setAllowedCapacity:y,addRoomsAmount:p,onAddTitleSetCustomValidity:()=>{const e=t.value.length;e<o?t.setCustomValidity("Минимальная длина — 30 символов, ещё "+(o-e)):t.setCustomValidity(""),t.reportValidity()},onInvalidAddPriceCheckValidity:()=>{r()},onInputAddPriceCheckValidity:()=>{r()},onChangeAccomodationType:c,onChangeCheckIn:()=>{var e;e=l.value,u.value=e},onChangeCheckOut:()=>{var e;e=u.value,l.value=e},onChangeAddRoomsAmount:()=>{y()}}})(),(()=>{const{template:e}=window.form,t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),n=e.querySelector("#address"),r=Math.floor(o.offsetLeft+32.5),i=Math.floor(o.offsetTop+32),d=()=>{n.value=`${r}, ${i}`};d(),n.setAttribute("readonly","true"),window.starterPin={assignAddress:()=>{const e=Math.floor(o.offsetTop+64),t=Math.floor(o.offsetLeft+32.5);n.value=`${t}, ${e}`},pinsArea:t,mainPin:o,PIN_WIDTH:65,PIN_HEIGHT:64,PIN_INCEPTION_X:570,PIN_INCEPTION_Y:375,setMainPinPosition:d}})(),(()=>{const{isEscEvent:e,roomsWordsEndings:t,guestsWordsEndings:o}=window.util,n={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},r=document.querySelector(".map"),i=document.querySelector(".map__filters-container"),d=document.createDocumentFragment(),s=document.querySelector("#card").content;s.querySelectorAll(".map__card > *:not(button):not(img)").forEach((e=>{e.innerHTML||e.remove()}));const a=t=>{e(t,c)},c=()=>{const e=r.querySelector(".map__card");e&&e.remove(),document.removeEventListener("keydown",a)};window.card={chart:r,showBlurb:e=>{c(),(e=>{const a=s.cloneNode(!0),{title:l,address:u,price:p,type:m,rooms:v,guests:y,checkin:f,checkout:h,features:w,description:g,photos:E}=e.offer,{avatar:_}=e.author;a.querySelector(".popup__close").addEventListener("click",(()=>{c()}));const L=a.querySelector(".popup__features");var S;L.innerHTML="",a.querySelector(".popup__type").textContent=n[m],a.querySelector(".popup__title").textContent=l,a.querySelector(".popup__text--address").textContent=u,a.querySelector(".popup__text--price").textContent=p+"₽/ночь",a.querySelector(".popup__text--capacity").textContent=`${v} комнат${t(v)} для ${y} гост${o(y)}`,a.querySelector(".popup__text--time").textContent=`Заезд после ${f}, выезд до ${h}`,L.appendChild((S=d,w.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,S.appendChild(t)})),S)),a.querySelector(".popup__description").textContent=g,((e,t)=>{const o=e.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");o.innerHTML="",t.forEach((e=>{const t=n.cloneNode(!0);t.src=e,d.appendChild(t)})),o.appendChild(d)})(a,E),a.querySelector(".popup__avatar").src=_,r.insertBefore(a,i)})(e),document.addEventListener("keydown",a)},shutBlurb:c,container:i}})(),(()=>{const{showBlurb:e}=window.card;window.pin={create:t=>{const o=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.createDocumentFragment();return t.forEach((t=>{const r=o.cloneNode(!0),i=r.querySelector("img");r.style=`left: ${t.location.x-i.width/2}px;\n                   top: ${t.location.y-i.height}px;`,i.src=t.author.avatar,i.alt=t.offer.title,n.append(r),r.addEventListener("click",(()=>{e(t)}))})),n}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const{template:e}=window.form,t=["gif","jpg","jpeg","png"],o={default:{width:"40px",height:"44px",borderRadius:"0",marginLeft:"0"},edited:{width:"70px",height:"70px",borderRadius:"5px",marginLeft:"-15px"}},n=e.querySelector(".ad-form__field input[type=file]"),r=e.querySelector(".ad-form-header__preview img"),i=e.querySelector(".ad-form__upload input[type=file]"),d=e.querySelector(".ad-form__photo"),s=(e,t)=>{e.style.width=t.width,e.style.height=t.height,e.style.borderRadius=t.borderRadius},a=(e,o)=>{const n=e.files[0],r=n.name.toLowerCase();if(t.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}};n.addEventListener("change",(()=>{const e=o.edited;s(r,e),r.style.marginLeft=e.marginLeft,a(n,r)})),i.addEventListener("change",(()=>{if(!d.querySelector("img")){const e=document.createElement("img");e.style.width="100%",e.style.height="100%",e.style.borderRadius="5px",e.alt="Фотография Вашего жилья",d.appendChild(e)}const t=e.querySelector(".ad-form__photo img");a(i,t)})),window.images={clearPhotos:()=>{const e=o.default;s(r,e),r.style.marginLeft=e.marginLeft,r.src="img/muffin-grey.svg",d.querySelector("img")&&d.firstChild.remove()}}})(),(()=>{const e="any",{create:t}=window.pin,{shutBlurb:o,chart:n}=window.card,{pinsArea:r}=window.starterPin,i=n.querySelector(".map__filters"),d=i.querySelectorAll("select"),s=i.querySelectorAll("input"),a=i.querySelector("#housing-type"),c=i.querySelector("#housing-price"),l=i.querySelector("#housing-rooms"),u=i.querySelector("#housing-guests"),p=i.querySelector(".map__features"),m=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};let v;const y=window.debounce((e=>{m(),r.append(t(e.slice(0,5)))})),f=t=>a.value===t.offer.type||a.value===e,h=t=>"low"===c.value&&t.offer.price<1e4||"middle"===c.value&&t.offer.price>=1e4&&t.offer.price<5e4||"high"===c.value&&t.offer.price>=5e4||c.value===t.offer.price||c.value===e,w=t=>+l.value===t.offer.rooms||l.value===e,g=t=>+u.value===t.offer.guests||u.value===e,E=e=>{const t=p.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))};window.map={chart:n,selects:d,inputs:s,erasePins:m,onLoad:e=>{v=e,y(e)},filter:i,onFilterGetBlurbs:()=>{const e=[];for(const t of v)if(f(t)&&h(t)&&w(t)&&g(t)&&E(t)&&(e.push(t),e.length===window.pin.PIN_LIMIT))break;o(),y(e)}}})(),(()=>{const{PIN_WIDTH:e,PIN_HEIGHT:t,assignAddress:o,pinsArea:n,mainPin:r}=window.starterPin,{chart:i}=window.map,d=n.offsetWidth,s=i.offsetTop+130-t,a=630-t,c=0+Math.ceil(e/2)-r.offsetWidth,l=d+Math.ceil(e/2)-r.offsetWidth;window.dragging={onStarterPinMouseMove:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const d=r.offsetLeft-n,u=r.offsetTop-i;d>=c&&d<=l&&(r.style.left=d+"px"),u>=s&&u<=a&&(r.style.top=u+"px"),o()},i=t=>{1===e.button&&t.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",i)}}})(),(()=>{const{selects:e,inputs:t,erasePins:o,onLoad:n,filter:r,onFilterGetBlurbs:i}=window.map,{assignAddress:d,mainPin:s,PIN_INCEPTION_X:a,PIN_INCEPTION_Y:c,setMainPinPosition:l}=window.starterPin,{shutBlurb:u,chart:p,container:m}=window.card,{isEnterEvent:v,isEscEvent:y,onError:f}=window.util,{onStarterPinMouseMove:h}=window.dragging,{load:w,upload:g}=window.server,{clearPhotos:E}=window.images,{template:_,setAllowedCapacity:L,addTitle:S,addPrice:q,checkIn:b,checkOut:C,accomodationType:A,addRoomsAmount:k,onAddTitleSetCustomValidity:P,onInvalidAddPriceCheckValidity:x,onInputAddPriceCheckValidity:I,onChangeAccomodationType:T,onChangeCheckIn:N,onChangeCheckOut:M,onChangeAddRoomsAmount:$}=window.form,D=_.querySelectorAll("select"),R=_.querySelectorAll("input"),V=_.querySelector("#description"),O=_.querySelector(".ad-form__element--submit"),H=e=>{e.forEach((e=>{e.setAttribute("disabled","true")}))},W=e=>{e.forEach((e=>{e.removeAttribute("disabled","true")}))};m.classList.add("hidden"),H(D),H(R),H(e),H(t),V.setAttribute("disabled","true"),O.setAttribute("disabled","true");const B=e=>{0===e.button&&oe()},j=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),F=()=>{Y()},X=e=>{y(e,Y)},G=e=>{v(e,oe)},Y=()=>{j.remove(),document.removeEventListener("click",F),document.removeEventListener("keydown",X)},U=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),z=()=>{p.appendChild(U),document.addEventListener("click",J),document.addEventListener("keydown",K)},J=()=>{Q()},K=e=>{y(e,Q)},Q=()=>{U.remove(),document.removeEventListener("click",J),document.removeEventListener("keydown",K)},Z=document.querySelector(".ad-form__reset"),ee=()=>{te()},te=()=>{u(),o(),_.reset(),L(),r.reset(),p.classList.add("map--faded"),_.classList.add("ad-form--disabled"),T(),s.style.left=a+"px",s.style.top=c+"px",l(),H(e),H(t),H(D),H(R),m.classList.add("hidden"),V.setAttribute("disabled","true"),O.setAttribute("disabled","true"),s.addEventListener("mousedown",B),Z.removeEventListener("click",ee),r.removeEventListener("change",i),S.removeEventListener("input",P),q.removeEventListener("input",I),q.removeEventListener("invalid",x),A.removeEventListener("change",T),b.removeEventListener("change",N),C.removeEventListener("change",M),k.removeEventListener("change",$),E()};s.addEventListener("mousedown",B),s.addEventListener("keydown",G),s.addEventListener("mousedown",h);const oe=()=>{_.classList.remove("ad-form--disabled"),p.classList.remove("map--faded"),m.classList.remove("hidden"),W(D),W(R),W(e),W(t),V.removeAttribute("disabled"),O.removeAttribute("disabled"),d(),w(n,f),_.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(_);g(t,(()=>{te(),p.appendChild(j),document.addEventListener("click",F),document.addEventListener("keydown",X)}),z),document.activeElement.blur()})),s.removeEventListener("keydown",G),s.removeEventListener("mousedown",B),Z.addEventListener("click",ee),r.addEventListener("change",i),S.addEventListener("input",P),q.addEventListener("input",I),q.addEventListener("invalid",x),A.addEventListener("change",T),b.addEventListener("change",N),C.addEventListener("change",M),k.addEventListener("change",$)}})()})();